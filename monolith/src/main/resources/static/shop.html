<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - Optivem eShop</title>
    <link rel="stylesheet" href="/common.css">
</head>
<body>
    <h1>Shop</h1>
    <nav>
        <a href="/">‚Üê Back to Home</a>
    </nav>
    
    <form id="orderForm" method="post" action="/shop">
        <div>
            <label for="productId">SKU:</label>
            <input type="text" id="productId" name="productId" aria-label="Product ID" />
        </div>
        <div>
            <label for="quantity">Quantity:</label>
            <input type="text" id="quantity" name="quantity" aria-label="Quantity" inputmode="numeric" />
        </div>
        <div>
            <label for="country">Country:</label>
            <input type="text" id="country" name="country" aria-label="Country" value="US" maxlength="2" />
        </div>
        <button type="submit" aria-label="Place Order">Place Order</button>
    </form>
    
    <div id="notifications" aria-live="polite"></div>

    <script src="/common.js"></script>
    <script>
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const productIdValue = document.getElementById('productId').value;
                const quantityValue = document.getElementById('quantity').value;
                const countryValue = document.getElementById('country').value;

                document.getElementById('notifications').innerHTML = '';

                const quantityTrimmed = quantityValue.trim();

                if (quantityTrimmed === '') {
                    showNotification('Quantity must not be empty', true);
                    return;
                }

                const quantityNum = parseFloat(quantityTrimmed);

                if (isNaN(quantityNum)) {
                    showNotification('Quantity must be an integer', true);
                    return;
                }

                if (!Number.isInteger(quantityNum)) {
                    showNotification('Quantity must be an integer', true);
                    return;
                }

                const sku = productIdValue.trim();
                const quantity = parseInt(quantityValue);
                const country = countryValue.trim();

                if (!sku) {
                    showNotification('SKU must not be empty', true);
                    return;
                }

                if (quantity <= 0) {
                    showNotification('Quantity must be positive', true);
                    return;
                }

                if (!country) {
                    showNotification('Country must not be empty', true);
                    return;
                }

                console.log('Creating order with:', { sku, quantity, country });

                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sku: sku,
                        quantity: quantity,
                        country: country
                    })
                });

                console.log('Order creation response status:', response.status, response.statusText);

                if (response.ok) {
                    const order = await response.json();
                    console.log('Order created successfully:', order);
                    showNotification('Success! Order has been created with Order Number ' + order.orderNumber, false);
                } else if (response.status === 404) {
                    try {
                        const errorData = await response.json();
                        console.log('404 error data:', errorData);

                        if (errorData.detail) {
                            showNotification(errorData.detail, true);
                        } else if (errorData.message) {
                            showNotification(errorData.message, true);
                        } else {
                            showNotification('Resource not found.', true);
                        }
                    } catch (e) {
                        console.error('Error parsing 404 response:', e);
                        showNotification('Resource not found.', true);
                    }
                } else if (response.status === 400 || response.status === 422) {
                    // Handle parsing errors (400) and validation errors (422)
                    try {
                        const errorData = await response.json();
                        console.log('Validation error data:', errorData);

                        let displayMessage = '';
                        
                        if (errorData.detail) {
                            displayMessage = errorData.detail;
                            
                            if (errorData.errors && errorData.errors.length > 0) {
                                const fieldErrors = errorData.errors.map(e => `${e.field}: ${e.message}`).join('; ');
                                displayMessage += '\n' + fieldErrors;
                            }
                        } else if (errorData.message) {
                            displayMessage = errorData.message;
                        } else {
                            displayMessage = Object.entries(errorData).map(([field, msg]) => `${field}: ${msg}`).join('; ');
                        }
                        
                        showNotification(displayMessage, true);
                    } catch (e) {
                        console.error('Error parsing validation error response:', e);
                        showNotification('Validation error. Please check your input.', true);
                    }
                } else {
                    console.error('Order creation failed with status:', response.status);
                    console.error('Response status text:', response.statusText);

                    response.text().then(body => {
                        console.error('Response body:', body);
                    }).catch(e => {
                        console.error('Could not read response body:', e);
                    });

                    showNotification('Error placing order. Please try again. (Status: ' + response.status + ')', true);
                }
            } catch (error) {
                console.error('Exception during order creation:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                showNotification('Error placing order. Please try again. (Exception: ' + error.message + ')', true);
            }
        });
    </script>
</body>
</html>
